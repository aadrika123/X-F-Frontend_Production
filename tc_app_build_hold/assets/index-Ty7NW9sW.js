import{e as Ge,d as Ke,b as h,m as F,Q as y,S as Pe,p as Qe,j as n,f as Be}from"./index-tJbU7ayB.js";import{P as We}from"./index-6o85-u81.js";import{e as Ye,d as De,r as z}from"./router-vSHQYlWC.js";import{u as $e}from"./formik.esm-feHG9Gj_.js";import{c as Je,a as w}from"./index.esm-YegZWto1.js";import{F as Ue}from"./FormProvider-fBqmJEVl.js";import{T as u}from"./TextField-QPeamiX3.js";import{S as k}from"./SelectField-T4CMJ1yZ.js";import{T as Re}from"./TextAreaField-sy2rrLiR.js";import"./TranslateField-wCz68bV9.js";import{r as Ze}from"./resizeImage-XQgyMl68.js";import{r as T}from"./tailwind-nPCoKmcy.js";import{u as He}from"./reactQuery-xwoMMF6K.js";import"./axios-lPgvryBG.js";import"./reactIcons-jqXmw8S_.js";import"./headlessui-kWR29u24.js";import"./customInputValidation-jhKsg103.js";function Xe({getConsumerDtl:f,getDemandDtl:b,id:o,shopDetails:d}){var _,P,B,D,R,O,M,E,q,G,K,Q,W,Y,$,J,U,Z,H,X,L,v,ee,ae,ne,te,de,re,oe,ce,ie,le,me,se,pe,ge,ue,xe,Ne,fe,be,he,je,ye,we,Fe,Ie,Ve,Ce,ke,Te,ze;const I=Ye(),{coords:N,isGeolocationEnabled:j,isGeolocationAvailable:Oe}=Ge(),Me=Ke({}),[Le,Ee]=De.useState(null),[S,A]=De.useState(!1),p=h({api:F.shopMaster,config:{},options:{enabled:!0}}),m=e=>{var r,t,c;return(c=(t=(r=d==null?void 0:d.data)==null?void 0:r.data)==null?void 0:t.shopDetails)==null?void 0:c.filter(l=>(l==null?void 0:l.key)===e)},V=(B=(P=(_=p==null?void 0:p.data)==null?void 0:_.data)==null?void 0:P.shopType)==null?void 0:B.find(e=>{var r,t;return(e==null?void 0:e.shop_type)==((t=(r=m("shopType"))==null?void 0:r[0])==null?void 0:t.value)}),C=(O=(R=(D=p==null?void 0:p.data)==null?void 0:D.data)==null?void 0:R.circleList)==null?void 0:O.find(e=>{var r,t;return(e==null?void 0:e.circle_name)==((t=(r=m("zone"))==null?void 0:r[0])==null?void 0:t.value)}),a=$e({enableReinitialize:!0,initialValues:{shopId:o!=null?o:0,amcShopNo:(E=(M=m("amcShopNo"))==null?void 0:M[0])==null?void 0:E.value,shopCategoryId:(V==null?void 0:V.id)||"",shopCategoryName:(G=(q=m("shopType"))==null?void 0:q[0])==null?void 0:G.value,circleId:(C==null?void 0:C.id)||"",circleName:(Q=(K=m("zone"))==null?void 0:K[0])==null?void 0:Q.value,marketId:"",marketName:(Y=(W=m("marketName"))==null?void 0:W[0])==null?void 0:Y.value,mobile_no:(J=($=m("contactNo"))==null?void 0:$[0])==null?void 0:J.value,alloteeName:(Z=(U=m("allotteeName"))==null?void 0:U[0])==null?void 0:Z.value,shopOwnerName:(X=(H=m("ownerName"))==null?void 0:H[0])==null?void 0:X.value,arrearDemand:(v=(L=d==null?void 0:d.data)==null?void 0:L.data)==null?void 0:v.arrearDemand,currentDemands:(ae=(ee=d==null?void 0:d.data)==null?void 0:ee.data)==null?void 0:ae.currentDemand,totalDemand:(te=(ne=d==null?void 0:d.data)==null?void 0:ne.data)==null?void 0:te.totalDemand,latitude:"",longitude:"",document:"",remarks:"",citizenComment:""},validationSchema:Je().shape({latitude:w().required("Latitude is required"),longitude:w().required("Longitude is required"),document:w().required("Document is required"),remarks:w().required("Remark is required")}),onSubmit:async(e,{resetForm:r})=>{if(!j)return y.error("Please enable location service");const t=new FormData;t.append("shopId",e==null?void 0:e.shopId),t.append("amcShopNo",e==null?void 0:e.amcShopNo),t.append("shopCategoryId",e==null?void 0:e.shopCategoryId),t.append("shopCategoryName",e==null?void 0:e.shopCategoryName),t.append("circleId",e==null?void 0:e.circleId),t.append("circleName",e==null?void 0:e.circleName),t.append("marketId",e==null?void 0:e.marketId),t.append("marketName",e==null?void 0:e.marketName),t.append("mobile_no",e==null?void 0:e.mobile_no),t.append("alloteeName",e==null?void 0:e.alloteeName),t.append("shopOwnerName",e==null?void 0:e.shopOwnerName),t.append("arrearDemand",e==null?void 0:e.arrearDemand),t.append("currentDemands",e==null?void 0:e.currentDemands),t.append("totalDemand",e==null?void 0:e.totalDemand),t.append("lat",e==null?void 0:e.latitude),t.append("lan",e==null?void 0:e.longitude),t.append("document",e==null?void 0:e.document),t.append("tcRemark",e==null?void 0:e.remarks),t.append("location","Ranchi"),t.append("citizenRemark",e==null?void 0:e.citizenComment),Pe.fire({title:"Are you sure?",text:"\n          You are going to submit the application for the visit. Please make sure all the details are correct.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, Proceed!",cancelButtonText:"No, cancel!",reverseButtons:!0}).then(async c=>{var l,g,Se,Ae,_e;if(c.isConfirmed)try{const s=await Me.mutateAsync({api:F.addTcVisit,data:t});(l=s==null?void 0:s.data)!=null&&l.status?(y.success((g=s==null?void 0:s.data)==null?void 0:g.message),I("/amc-app/adv-municipal-rental/list-shop-visit",{replace:!0}),r()):y.error((Se=s==null?void 0:s.data)==null?void 0:Se.message)}catch(s){y.error((_e=(Ae=s==null?void 0:s.response)==null?void 0:Ae.data)==null?void 0:_e.message)}}).catch(c=>{var l,g;console.log(c),y.error((g=(l=c==null?void 0:c.response)==null?void 0:l.data)==null?void 0:g.message)})}}),i=h({api:F.listWiseCircleMarket,key:"marketList",config:{circleId:(de=a==null?void 0:a.values)==null?void 0:de.circleId},value:[(re=a==null?void 0:a.values)==null?void 0:re.circleId],options:{enabled:!!((oe=a==null?void 0:a.values)!=null&&oe.circleId),onSuccess:e=>{var r;((r=e==null?void 0:e.data)==null?void 0:r.length)>0?A(!0):A(!1)}}});z.useEffect(()=>{var e,r,t;S&&(a==null||a.setFieldValue("marketId",(t=(r=(e=i==null?void 0:i.data)==null?void 0:e.data)==null?void 0:r.find(c=>{var l,g;return(c==null?void 0:c.market_name)==((g=(l=m("marketName"))==null?void 0:l[0])==null?void 0:g.value)}))==null?void 0:t.id))},[S,o]),(le=(ie=(ce=i==null?void 0:i.data)==null?void 0:ce.data)==null?void 0:ie.find(e=>{var r,t;return(e==null?void 0:e.market_name)==((t=(r=m("marketName"))==null?void 0:r[0])==null?void 0:t.value)}))==null||le.id,z.useEffect(()=>{o||(a.setFieldValue("amcShopNo",""),a.setFieldValue("shopCategoryId",""),a.setFieldValue("shopCategoryName",""),a.setFieldValue("circleId",""),a.setFieldValue("circleName",""),a.setFieldValue("marketId",""),a.setFieldValue("marketName",""),a.setFieldValue("mobile_no",""),a.setFieldValue("alloteeName",""),a.setFieldValue("shopOwnerName",""),a.setFieldValue("arrearDemand",""),a.setFieldValue("currentDemands",""),a.setFieldValue("totalDemand",""),a.setFieldValue("latitude",""),a.setFieldValue("longitude",""),a.setFieldValue("document",""),a.setFieldValue("remarks",""),a.setFieldValue("citizenComment",""))},[!o]);const{values:x}=a;h({api:Qe.getWardByZone,config:{zoneId:x==null?void 0:x.zoneId},value:[x==null?void 0:x.zoneId],options:{enabled:!!(x!=null&&x.zoneId)}});const qe=async e=>{var c,l,g;if(!((c=e.target)!=null&&c.files[0]))return;await((l=window==null?void 0:window.ReactNativeWebView)==null?void 0:l.postMessage(JSON.stringify({Key:"OPEN_CAMERA"})));const r=await Ze(e.target.files[0]),t=new File([r],(g=e.target.files[0])==null?void 0:g.name,{type:"image/*"});a.setFieldValue("latitude",N==null?void 0:N.latitude),a.setFieldValue("longitude",N==null?void 0:N.longitude),a.setFieldValue("document",t),Ee(t)};return n.jsx(T.Card,{children:n.jsx(T.CardBody,{color:"blue",children:n.jsxs(Ue,{formik:a,children:[n.jsx("div",{className:"p-2",children:n.jsxs("div",{className:"row",children:[n.jsxs("div",{className:"col-md-6",children:[n.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[n.jsx("div",{className:"col-span-2",children:n.jsx(u,{name:"amcShopNo",label:"AMC Shop No",formik:a})}),n.jsx("div",{children:n.jsxs(k,{label:"Shop category",name:"shopCategoryId",formik:a,selectedText:"shopCategoryName",children:[n.jsx("option",{value:"",children:"select"}),(pe=(se=(me=p==null?void 0:p.data)==null?void 0:me.data)==null?void 0:se.shopType)==null?void 0:pe.map(e=>n.jsx("option",{value:e==null?void 0:e.id,children:e==null?void 0:e.shop_type},e==null?void 0:e.id))]})}),n.jsx("div",{children:n.jsxs(k,{label:"Zone",name:"circleId",selectedText:"circleName",formik:a,children:[n.jsx("option",{value:"",children:"select"}),(xe=(ue=(ge=p==null?void 0:p.data)==null?void 0:ge.data)==null?void 0:ue.circleList)==null?void 0:xe.map(e=>n.jsx("option",{value:e==null?void 0:e.id,children:e==null?void 0:e.circle_name},e==null?void 0:e.id))]})}),n.jsxs("div",{className:"col-span-2",children:[n.jsxs(k,{label:"Market",formik:a,name:"marketId",selectedText:"marketName",disabled:i==null?void 0:i.isLoading,children:[n.jsx("option",{value:"",children:"select"}),(fe=(Ne=i==null?void 0:i.data)==null?void 0:Ne.data)==null?void 0:fe.map(e=>n.jsx("option",{value:e==null?void 0:e.id,children:e==null?void 0:e.market_name},e==null?void 0:e.id))]}),n.jsx("small",{className:"text-blue-500",children:(i==null?void 0:i.isLoading)&&"Please wait..."})]})]}),n.jsx(u,{name:"mobile_no",label:"Mobile no",formik:a,disabled:o&&((he=(be=m("contactNo"))==null?void 0:be[0])==null?void 0:he.value)}),n.jsx(u,{name:"alloteeName",label:"Allotee Name",formik:a,disabled:o&&((ye=(je=m("allotteeName"))==null?void 0:je[0])==null?void 0:ye.value)}),n.jsx(u,{name:"shopOwnerName",label:"Shop Owner Name",formik:a,disabled:o&&((Fe=(we=m("shopOwnerName"))==null?void 0:we[0])==null?void 0:Fe.value)}),n.jsx(u,{name:"arrearDemand",label:"Arrear Demand",formik:a,disabled:o&&((Ve=(Ie=d==null?void 0:d.data)==null?void 0:Ie.data)==null?void 0:Ve.arrearDemand)}),n.jsx(u,{name:"currentDemands",label:"Current Demand",formik:a,disabled:o&&((ke=(Ce=d==null?void 0:d.data)==null?void 0:Ce.data)==null?void 0:ke.currentDemand)})]}),n.jsxs("div",{className:"col-md-6",children:[n.jsx(u,{name:"totalDemand",label:"Total Demand",formik:a,disabled:o&&((ze=(Te=d==null?void 0:d.data)==null?void 0:Te.data)==null?void 0:ze.totalDemand)}),n.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[n.jsxs("div",{className:"col-span-2",children:[n.jsx(u,{label:"Document",type:"file",capture:"environment",name:"document",accept:"image/*",onChange:e=>{if(!j||!Oe){e.target.value=null,Pe.fire({title:"Location Service",text:"Please enable location service",icon:"warning",confirmButtonText:"Ok",reverseButtons:!0});return}qe(e)}}),a.errors.document&&a.touched.document?n.jsx("small",{className:"text-red-500 -mt-2",children:a.errors.document}):null]}),n.jsx("div",{children:n.jsx(u,{name:"latitude",label:"Latitude",formik:a,disabled:!0})}),n.jsx("div",{children:n.jsx(u,{name:"longitude",label:"Longitude",formik:a,disabled:!0})})]}),n.jsx(Re,{name:"remarks",label:"Remarks",formik:a}),n.jsx(Re,{name:"citizenComment",label:"Citizen Comment",formik:a})]})]})}),n.jsx("div",{className:"flex justify-center",children:n.jsx(T.Button,{size:"sm",type:"submit",className:"btn btn-primary",children:"Submit"})})]})})})}function Na(){var j;const f=He(),b=new URLSearchParams(window.location.search),o=b.get("shop-id"),d=h({api:Be.waterGetDetails,key:"waterVisitDetail",config:{applicationId:b.get("id")},options:{enabled:!!b.get("id")}}),I=h({api:Be.waterListDemand,key:"waterVisitListDemand",config:{ConsumerId:b.get("id")},options:{enabled:!!b.get("id")}}),N=h({api:(j=F)==null?void 0:j.shopDetailById,config:{id:o},options:{enabled:!!o}});return z.useEffect(()=>{o||(f==null||f.removeQueries({queryKey:"waterVisitDetail",exact:!0}),f==null||f.removeQueries({queryKey:"waterVisitListDemand",exact:!0}))},[!o]),n.jsx(We,{title:"Market Visiting",children:n.jsx("div",{className:"p-2",children:n.jsx(Xe,{getConsumerDtl:d,getDemandDtl:I,id:b.get("shop-id"),shopDetails:N})})})}export{Na as default};
