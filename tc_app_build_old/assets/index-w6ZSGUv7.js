import{b as fe,d as be,e as Te,c as ie,p as re,w as we,S as oe,Q as u,j as e,I as Ne}from"./index-iVUjWhr9.js";import{d as p,u as ve,e as Fe,f as Pe,r as Ie}from"./router-5yjtezO8.js";import{c as ne,b as Le,a as b,d as $e}from"./index.esm-uHa2PMRf.js";import{r as h}from"./tailwind-6U-kYQAu.js";import{u as Ae,F as Ce}from"./formik.esm-BnzrXcQN.js";import{F as Re}from"./FormProvider-bvmZiPgo.js";import{T as de}from"./TextField-xwBIJIwU.js";import{T as Ee}from"./TextAreaField-6pPVNPMx.js";import"./index-iFVn5AxS.js";import{P as Se}from"./index-6UKcasu-.js";import{r as _e}from"./resizeImage-0R1C6TG9.js";import{u as qe}from"./useErrorFocusFields-mwtEYYKc.js";import{O as Be}from"./OverLayLoader-laS6Seqn.js";import{u as Ge}from"./usePathWisePermission-nh8NIYS4.js";import"./reactQuery-QTVGT_ni.js";import"./axios-lPgvryBG.js";import"./reactIcons-ElHvrKTF.js";import"./headlessui-iZReL1Rn.js";import"./customInputValidation-jhKsg103.js";import"./module-UibcSNar.js";function nt(){var F,P,I,L,$,A,C,R,E,S,_,q,B,G,O,V,M,z,W,H,U,Y;fe();const[le,Oe]=p.useState(""),{AutoFocusErrorField:ce}=qe(),[x,ge]=p.useState([]),me=ve(),T=be({}),[Ve,ue]=p.useState(null),{id:j}=Fe(),{pathname:y}=Pe();Ge((P=(F=y==null?void 0:y.split("/"))==null?void 0:F.slice(0,-1))==null?void 0:P.join("/"));const{coords:m,isGeolocationEnabled:pe}=Te(),t=ie({api:re.staticSafDetail,config:{applicationId:j},value:[j],options:{enabled:!!j}}),f=ie({api:(I=we)==null?void 0:I.workFlowInfo,config:{workflowId:($=(L=t==null?void 0:t.data)==null?void 0:L.data)==null?void 0:$.workflow_id},value:[(C=(A=t==null?void 0:t.data)==null?void 0:A.data)==null?void 0:C.workflow_id],options:{enabled:!!((E=(R=t==null?void 0:t.data)==null?void 0:R.data)!=null&&E.workflow_id)}}),a=Ae({enableReinitialize:!0,initialValues:{geoTagged:x==null?void 0:x.map(o=>({latitude:"",longitude:"",altitude:"",accuracy:"",imagePath:"",directionType:"",rainWaterHarvesting:""})),comment:""},validationSchema:ne().shape({geoTagged:Le().of(ne().shape({latitude:b().required("Latitude is required"),longitude:b().required("Longitude is required"),directionType:b().required("Direction is required"),imagePath:$e().required("Image is required")}))}),onSubmit:async o=>{oe.fire({title:"Are you sure?",text:"\n        You are going to submit the Geo Tagging. Once submitted, you can't edit the Geo Tagging?",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, Proceed!",cancelButtonText:"No, cancel!",reverseButtons:!0}).then(i=>{i.isConfirmed&&he(o)}).catch(i=>{var r,n;console.log(i),u.error((n=(r=i==null?void 0:i.response)==null?void 0:r.data)==null?void 0:n.message)})}}),he=async o=>{var r,n,d,l,c;if((o==null?void 0:o.comment)=="")return u.error("Comment is required !");const i=new FormData;i.append("safId",j),o==null||o.geoTagged.forEach((s,g)=>{i.append("latitude[".concat(g,"]"),s==null?void 0:s.latitude),i.append("longitude[".concat(g,"]"),s==null?void 0:s.longitude),i.append("directionType[".concat(g,"]"),s==null?void 0:s.directionType),i.append("imagePath[".concat(g,"]"),s==null?void 0:s.imagePath)});try{const s=await T.mutateAsync({api:re.geoTagging,data:i});(r=s==null?void 0:s.data)!=null&&r.status?(u.success((n=s==null?void 0:s.data)==null?void 0:n.message),me("/amc-app/property/survey",{replace:!0})):u.error((d=s==null?void 0:s.data)==null?void 0:d.message)}catch(s){u.error((c=(l=s==null?void 0:s.response)==null?void 0:l.data)==null?void 0:c.message)}},{submitCount:w,isSubmitting:N,errors:v,isValid:xe}=a,je=async(o,i,r)=>{var l,c;await((l=window==null?void 0:window.ReactNativeWebView)==null?void 0:l.postMessage(JSON.stringify({Key:"OPEN_CAMERA"})));const n=await _e(o.target.files[0]),d=new File([n],(c=o.target.files[0])==null?void 0:c.name,{type:"image/*"});a.setFieldValue("geoTagged.".concat(i,".latitude"),m==null?void 0:m.latitude),a.setFieldValue("geoTagged.".concat(i,".longitude"),m==null?void 0:m.longitude),a.setFieldValue("geoTagged.".concat(i,".directionType"),r==null?void 0:r.directionType),a.setFieldValue("geoTagged.".concat(i,".imagePath"),d),ue(d)};return Ie.useEffect(()=>{var o,i,r;(o=t==null?void 0:t.data)!=null&&o.data&&ge((r=(i=t==null?void 0:t.data)==null?void 0:i.data)!=null&&r.is_water_harvesting?[{id:1,title:"Front Image",directionType:"Front"},{id:2,title:"Left Image",directionType:"Left"},{id:3,title:"Right Image",directionType:"Right"},{id:4,title:"Rain Water Harvesting Image",directionType:"waterHarvesting",isRainWaterHarvesting:!0}]:[{id:1,title:"Front Image",directionType:"Front"},{id:2,title:"Left Image",directionType:"Left"},{id:3,title:"Right Image",directionType:"Right"}])},[(_=(S=t==null?void 0:t.data)==null?void 0:S.data)==null?void 0:_.saf_no]),p.useEffect(()=>{ce({submitCount:w,isSubmitting:N,errors:v,isValid:xe})},[v,w,N]),pe||oe.fire({text:"Geolocation is not enabled! Please enable to use this app",icon:"error",confirmButtonText:"Ok"}),le?e.jsx("div",{className:"p-16 flex text-center text-red-500 font-semibold h-screen justify-center items-center",children:"Network Error"}):t!=null&&t.isLoading?e.jsx(Ne,{}):e.jsxs(Se,{title:"Geo Tagging",children:[T.isLoading&&e.jsx(Be,{}),e.jsxs("div",{className:"p-4 ",children:[e.jsx(h.Card,{className:"w-full",children:e.jsxs(h.CardBody,{children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsx("h1",{className:"font-semibold",children:"Geo Tagging"})}),e.jsx("div",{className:"border-b-2 border-gray-300 w-full py-1"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mt-3",children:[e.jsx("h1",{className:"font-semibold text-sm",children:"Application No : "}),e.jsx("h1",{className:"text-sm",children:(B=(q=t==null?void 0:t.data)==null?void 0:q.data)==null?void 0:B.saf_no}),e.jsx("h1",{className:"font-semibold text-sm",children:"Application Type : "}),e.jsx("h1",{className:"text-sm",children:(O=(G=t==null?void 0:t.data)==null?void 0:G.data)==null?void 0:O.assessment_type}),e.jsx("h1",{className:"font-semibold text-sm",children:"Mobile No : "}),e.jsx("h1",{className:"text-sm w-40 truncate",children:(W=(z=(M=(V=t==null?void 0:t.data)==null?void 0:V.data)==null?void 0:M.owners)==null?void 0:z.map(o=>o==null?void 0:o.mobile_no))==null?void 0:W.join(", ")})]})]})}),e.jsx("div",{className:"my-4 border-b-2"}),e.jsxs(Re,{formik:a,children:[e.jsx(Ce,{name:"geoTagged",children:o=>x.map((i,r)=>{var n,d,l,c,s,g,J,K,Q,X,Z,k,D,ee,te,ae,se;return e.jsxs(p.Fragment,{children:[e.jsxs(h.Card,{className:"w-full",children:[e.jsx("div",{className:"flex justify-between items-center px-5 bg-blue-gray-400 py-2 rounded-tl-lg rounded-tr-lg",children:e.jsx("h1",{className:"text-base font-semibold text-gray-100",children:i==null?void 0:i.title})}),e.jsxs(h.CardBody,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3 items-center",children:[e.jsx("h1",{className:"font-semibold text-sm",children:"Latitude : "}),e.jsx(de,{disabled:!0,type:"text",isDynamic:!0,name:"geoTagged.".concat(r,".latitude"),formik:a}),e.jsxs("h1",{className:"font-semibold text-sm",children:["Longitude :"," "]}),e.jsx(de,{disabled:!0,type:"text",isDynamic:!0,name:"geoTagged.".concat(r,".longitude"),formik:a})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 mt-4",children:[e.jsx("div",{children:((d=(n=a==null?void 0:a.values)==null?void 0:n.geoTagged[r])==null?void 0:d.imagePath)&&e.jsx("img",{className:"w-full h-64",loading:"lazy",src:(c=(l=a==null?void 0:a.values)==null?void 0:l.geoTagged[r])!=null&&c.imagePath?URL.createObjectURL((g=(s=a==null?void 0:a.values)==null?void 0:s.geoTagged[r])==null?void 0:g.imagePath):null,alt:(Q=(K=(J=a==null?void 0:a.values)==null?void 0:J.geoTagged[r])==null?void 0:K.imagePath)==null?void 0:Q.name})}),e.jsxs("div",{children:[e.jsx("input",{type:"file",name:"imagePath",accept:"image/*",onChange:ye=>je(ye,r,i)}),e.jsx("span",{className:"text-sm text-red-500",children:(k=(Z=(X=a==null?void 0:a.errors)==null?void 0:X.geoTagged)==null?void 0:Z[r])==null?void 0:k.imagePath})]}),e.jsx("div",{children:e.jsx("h1",{className:"text-sm text-red-900",children:((ee=(D=a==null?void 0:a.values)==null?void 0:D.geoTagged[r])==null?void 0:ee.imagePath)&&Math.round(((se=(ae=(te=a==null?void 0:a.values)==null?void 0:te.geoTagged[r])==null?void 0:ae.imagePath)==null?void 0:se.size)/1024/1024*100)/100+"MB"})})]})]})]}),e.jsx("div",{className:"my-4 border-b-2"})]},r)})}),e.jsx(Ee,{name:"comment",label:"Comment",formik:a}),e.jsx("div",{className:"flex justify-center items-center mt-4 gap-3",children:((Y=(U=(H=f==null?void 0:f.data)==null?void 0:H.data)==null?void 0:U.permissions)==null?void 0:Y.can_forward)&&e.jsx(h.Button,{type:"submit",size:"sm",className:"bg-blue-500 text-white",children:e.jsx("small",{children:"Send to back office"})})})]})]})]})}export{nt as default};
